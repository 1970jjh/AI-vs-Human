<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 1% Challenge</title>
    <style>
        :root {
            --bg-color: #f0f2f5; 
            --main-bg: #ffffff; 
            --primary-color: #1e88e5;
            --accent-color: #ffc107; 
            --text-color: #37474f; 
            --border-color: #cfd8dc;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --error-color: #f44336;
            --joker-color: #9c27b0;
        }
        
        * {
            box-sizing: border-box;
        }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            display: flex; 
            justify-content: center; 
            align-items: flex-start; 
            min-height: 100vh; 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            padding: 20px; 
            margin: 0;
        }
        
        #app-container { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 20px; 
            width: 100%; 
            max-width: 1200px; 
        }
        
        #left-panel { 
            flex: 1; 
            min-width: 320px; 
            display: flex; 
            flex-direction: column; 
            gap: 20px; 
        }
        
        #right-panel { 
            flex: 2; 
            min-width: 400px; 
        }
        
        .panel { 
            background: var(--main-bg); 
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.08); 
        }
        
        h1, h2 { 
            text-align: center; 
            margin-top: 0; 
            color: var(--primary-color); 
        }
        
        h1 {
            font-size: 1.8em;
            margin-bottom: 10px;
        }
        
        h2 {
            font-size: 1.3em;
            margin-bottom: 15px;
        }
        
        #number-panel { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(42px, 1fr)); 
            gap: 8px; 
        }
        
        .number-btn { 
            aspect-ratio: 1 / 1; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            font-size: 1.1em; 
            font-weight: bold; 
            border: 2px solid var(--border-color); 
            border-radius: 8px; 
            cursor: pointer; 
            transition: all 0.2s ease; 
            background-color: #fff; 
        }
        
        .number-btn:hover:not(:disabled) { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 8px rgba(0,0,0,0.15); 
            border-color: var(--primary-color);
        }
        
        .number-btn:disabled { 
            background-color: #e0e0e0; 
            color: #9e9e9e; 
            cursor: not-allowed; 
            text-decoration: line-through; 
            transform: none;
        }
        
        .number-btn.joker { 
            color: var(--joker-color); 
            font-size: 1.5em; 
            border-color: var(--joker-color); 
            background: linear-gradient(45deg, #f3e5f5, #fff);
        }
        
        .number-btn.joker:hover:not(:disabled) {
            border-color: var(--joker-color);
            box-shadow: 0 4px 8px rgba(156, 39, 176, 0.3);
        }
        
        #score-table { 
            display: flex; 
            justify-content: center; 
            gap: 20px; 
        }
        
        .score-column { 
            display: flex; 
            flex-direction: column; 
            gap: 5px; 
            flex-basis: 120px; 
        }
        
        .score-entry { 
            display: flex; 
            justify-content: space-between; 
            padding: 6px 8px; 
            background-color: #f7f9fc; 
            border-radius: 4px; 
            font-size: 0.95em; 
        }
        
        .score-entry span:first-child { 
            font-weight: bold; 
        }
        
        .score-entry span:last-child { 
            font-weight: bold; 
            color: var(--success-color); 
        }
        
        #game-board-container { 
            position: relative; 
        }
        
        #game-board { 
            display: grid; 
            grid-template-columns: repeat(6, 1fr); 
            grid-template-rows: repeat(10, 1fr); 
            gap: 8px; 
            height: 600px; 
            max-height: 80vh; 
        }
        
        .board-cell { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            font-size: 1.5em; 
            font-weight: bold; 
            border-radius: 8px; 
            background-color: #e3f2fd; 
            border: 2px dashed #90caf9; 
            visibility: hidden; 
            transition: all 0.3s ease; 
        }
        
        .board-cell.active { 
            visibility: visible; 
        }
        
        .board-cell.filled { 
            background-color: var(--main-bg); 
            border: 2px solid var(--primary-color); 
            color: var(--text-color); 
        }
        
        .board-cell.filled.joker { 
            background-color: #f3e5f5; 
            border: 2px solid var(--joker-color); 
            color: var(--joker-color); 
            font-size: 2em;
        }
        
        .board-cell.highlight { 
            transform: scale(1.05); 
            box-shadow: 0 0 15px var(--accent-color); 
            border-color: var(--accent-color);
            animation: pulse 1s ease-in-out;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1.05); }
            50% { transform: scale(1.1); }
        }
        
        .board-cell.manual-mode { 
            cursor: pointer; 
            background-color: #fffde7; 
            border: 2px solid var(--error-color); 
            animation: blink 1s ease-in-out infinite;
        }
        
        @keyframes blink {
            0%, 100% { background-color: #fffde7; }
            50% { background-color: #ffecb3; }
        }
        
        .board-cell.manual-mode:hover { 
            transform: scale(1.05); 
            box-shadow: 0 0 10px rgba(244, 67, 54, 0.5); 
        }
        
        #final-score-overlay { 
            position: absolute; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background: transparent; 
            display: none; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            text-align: center; 
            border-radius: 12px; 
            pointer-events: none;
        }
        
        #loading-overlay { 
            position: absolute; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background: rgba(255, 255, 255, 0.95); 
            display: none; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            text-align: center; 
            border-radius: 12px; 
            backdrop-filter: blur(3px); 
        }
        
        #final-score-overlay.show, #loading-overlay.show { 
            display: flex; 
        }
        
        #final-score-text { 
            font-size: 2.5em; 
            color: var(--warning-color); 
            margin-bottom: 10px;
        }
        
        #final-score-value { 
            font-size: 5em; 
            font-weight: bold; 
            color: var(--success-color); 
        }
        
        .loader { 
            font-size: 1.8em; 
            color: var(--primary-color); 
            font-weight: bold; 
            animation: thinking 2s ease-in-out infinite;
        }
        
        @keyframes thinking {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        #reset-button { 
            margin-top: 15px; 
            padding: 12px 20px; 
            border: none; 
            border-radius: 8px; 
            font-size: 1.1em; 
            font-weight: bold; 
            cursor: pointer; 
            background-color: var(--error-color); 
            color: white; 
            width: 100%; 
            transition: background-color 0.2s ease;
        }
        
        #reset-button:hover { 
            background-color: #d32f2f; 
        }
        
        #turn-counter { 
            text-align: center; 
            font-size: 1.2em; 
            font-weight: bold; 
            color: var(--primary-color); 
            margin-top: -10px; 
            margin-bottom: 10px; 
        }
        
        .status-message {
            text-align: center;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
            font-weight: bold;
            font-size: 0.95em;
        }
        
        .status-success {
            background-color: #e8f5e8;
            color: var(--success-color);
            border: 1px solid var(--success-color);
        }
        
        .status-error {
            background-color: #ffebee;
            color: var(--error-color);
            border: 1px solid var(--error-color);
        }
        
        .status-warning {
            background-color: #fff3e0;
            color: var(--warning-color);
            border: 1px solid var(--warning-color);
        }
        
        .manual-instruction {
            background-color: #fff3e0;
            color: var(--warning-color);
            border: 1px solid var(--warning-color);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: bold;
            text-align: center;
            animation: flash 2s ease-in-out infinite;
        }
        
        @keyframes flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        @media (max-width: 768px) {
            #app-container {
                flex-direction: column;
            }
            
            #left-panel, #right-panel {
                min-width: 100%;
            }
            
            #game-board {
                height: 400px;
            }
            
            .board-cell {
                font-size: 1.2em;
            }
        }
    </style>
</head>
<body>
    <div id="app-container">
        <div id="left-panel">
            <div class="panel">
                <h2>ìˆ«ì ì„ íƒ <span id="turn-counter">(1/20)</span></h2>
                <div id="number-panel"></div>
                <div id="status-message"></div>
                <div id="manual-instruction"></div>
            </div>
            <div class="panel">
                <h2>ì ìˆ˜í‘œ</h2>
                <div id="score-table">
                    <div id="score-col-1" class="score-column"></div>
                    <div id="score-col-2" class="score-column"></div>
                </div>
            </div>
            <button id="reset-button">ğŸ”„ ê²Œì„ ë‹¤ì‹œ ì‹œì‘</button>
        </div>
        <div id="right-panel">
            <div class="panel">
                <h1>ğŸ¯ AI 1% Challenge</h1>
                <div id="game-board-container">
                    <div id="game-board"></div>
                    <div id="loading-overlay">
                        <div class="loader">ğŸ¤” AIê°€ ìµœì ì˜ ìˆ˜ë¥¼ ê³„ì‚° ì¤‘...</div>
                    </div>
                    <div id="final-score-overlay">
                        <div id="final-score-text">ğŸ‰ ìµœì¢… ì ìˆ˜ ğŸ‰</div>
                        <div id="final-score-value">0</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const BOARD_SIZE = 20;
            const SCORE_TABLE = [0, 0, 1, 3, 5, 7, 9, 11, 15, 20, 25, 30, 35, 40, 50, 60, 70, 85, 100, 150, 300];
            const RUN_COLORS = ['#ffadad', '#ffd6a5', '#fdffb6', '#caffbf', '#9bf6ff', '#a0c4ff', '#bdb2ff', '#ffc6ff'];
            
            // ìŠ¤íŠ¸ë¦¼ìŠ¤ ê²Œì„ì˜ ì‹¤ì œ ë³´ë“œ ë ˆì´ì•„ì›ƒ (Lì í˜•íƒœ)
            const BOARD_MAP = [
                { r: 1, c: 1 }, { r: 1, c: 2 }, { r: 1, c: 3 }, { r: 1, c: 4 }, { r: 1, c: 5 }, { r: 1, c: 6 },
                { r: 2, c: 6 }, { r: 3, c: 6 }, { r: 4, c: 6 }, { r: 5, c: 6 }, { r: 6, c: 6 }, { r: 7, c: 6 }, 
                { r: 8, c: 6 }, { r: 9, c: 6 }, { r: 10, c: 6 }, { r: 10, c: 5 }, { r: 10, c: 4 }, { r: 10, c: 3 }, 
                { r: 10, c: 2 }, { r: 10, c: 1 }
            ];
            
            let boardState = Array(BOARD_SIZE).fill(null);
            let fullDeck = [];
            let turnCount = 0;
            let lastPlacedIndex = -1;
            let gameInProgress = false;
            let manualModeActive = false;
            let currentManualNumber = null;
            
            const elements = {
                numberPanel: document.getElementById('number-panel'),
                scoreCol1: document.getElementById('score-col-1'),
                scoreCol2: document.getElementById('score-col-2'),
                gameBoard: document.getElementById('game-board'),
                finalScoreOverlay: document.getElementById('final-score-overlay'),
                finalScoreValue: document.getElementById('final-score-value'),
                resetButton: document.getElementById('reset-button'),
                turnCounter: document.getElementById('turn-counter'),
                loadingOverlay: document.getElementById('loading-overlay'),
                statusMessage: document.getElementById('status-message'),
                manualInstruction: document.getElementById('manual-instruction')
            };

            function showStatusMessage(message, type = 'info') {
                elements.statusMessage.innerHTML = message;
                elements.statusMessage.className = 'status-message';
                if (type === 'success') {
                    elements.statusMessage.classList.add('status-success');
                } else if (type === 'error') {
                    elements.statusMessage.classList.add('status-error');
                } else if (type === 'warning') {
                    elements.statusMessage.classList.add('status-warning');
                }
                
                setTimeout(() => {
                    if (!manualModeActive) {
                        elements.statusMessage.innerHTML = '';
                        elements.statusMessage.className = 'status-message';
                    }
                }, 3000);
            }

            function showManualInstruction(message) {
                elements.manualInstruction.innerHTML = message;
                elements.manualInstruction.className = 'manual-instruction';
            }

            function hideManualInstruction() {
                elements.manualInstruction.innerHTML = '';
                elements.manualInstruction.className = '';
            }

            function enterManualMode(numberData, reason = '') {
                manualModeActive = true;
                currentManualNumber = numberData.number;
                
                console.log(`ìˆ˜ë™ ëª¨ë“œ ì§„ì…: ìˆ«ì ${currentManualNumber}, ì´ìœ : ${reason}`);
                
                elements.loadingOverlay.classList.remove('show');
                
                const reasonText = reason || `ìˆ«ì '${currentManualNumber}'ëŠ” 3~18ë²ˆì§¸ ì¹¸ì—ì„œ ì—°ì† ì˜¤ë¦„ì°¨ìˆœì„ ë§Œë“¤ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`;
                showStatusMessage(âš ï¸ ìˆ˜ë™ ë°°ì¹˜ ëª¨ë“œ: ${reasonText}`, 'warning');
                showManualInstruction(`ğŸ¯ ìˆ«ì ${currentManualNumber}ë¥¼ ì›í•˜ëŠ” ìœ„ì¹˜ì— í´ë¦­í•˜ì—¬ ë°°ì¹˜í•˜ì„¸ìš”! (ê¹œë¹¡ì´ëŠ” ì¹¸ë“¤ì„ í´ë¦­)`);
                
                // ëª¨ë“  ë¹ˆì¹¸ì„ ìˆ˜ë™ ë°°ì¹˜ ê°€ëŠ¥í•˜ê²Œ ì„¤ì •
                const activeCells = document.querySelectorAll('.board-cell.active');
                activeCells.forEach(cell => {
                    const boardIndex = parseInt(cell.dataset.boardIndex, 10);
                    if (boardState[boardIndex] === null) {
                        cell.classList.add('manual-mode');
                        const manualHandler = () => handleManualPlacement(boardIndex, currentManualNumber);
                        cell.addEventListener('click', manualHandler, { once: true });
                        cell.manualHandler = manualHandler; 
                    }
                });
            }

            function exitManualMode() {
                manualModeActive = false;
                currentManualNumber = null;
                
                // ëª¨ë“  ìˆ˜ë™ ëª¨ë“œ ìŠ¤íƒ€ì¼ ì œê±°
                const manualCells = document.querySelectorAll('.board-cell.manual-mode');
                manualCells.forEach(cell => {
                    cell.classList.remove('manual-mode');
                    if (cell.manualHandler) {
                        cell.removeEventListener('click', cell.manualHandler);
                        cell.manualHandler = null;
                    }
                });
                
                hideManualInstruction();
            }

            function handleManualPlacement(index, number) {
                exitManualMode();

                boardState[index] = number;
                lastPlacedIndex = index;
                renderGameBoard();
                
                showStatusMessage(`âœ… ìˆ˜ë™ ë°°ì¹˜ ì™„ë£Œ: ${number} â†’ ìœ„ì¹˜ ${index + 1}ë²ˆì§¸ ì¹¸`, 'success');
                
                if (turnCount >= BOARD_SIZE) {
                    elements.turnCounter.textContent = ' (ì™„ë£Œ)';
                    endGame();
                } else {
                    updateTurnCounter();
                }
            }

            function onAISuccess(placementData) {
                elements.loadingOverlay.classList.remove('show');
                
                // *** ìˆ˜ë™ ëª¨ë“œ ì „í™˜ í™•ì¸ ***
                if (placementData.index === -1 && placementData.number === "MANUAL_MODE") {
                    console.log("AIê°€ ìˆ˜ë™ ëª¨ë“œ ì „í™˜ì„ ìš”ì²­í–ˆìŠµë‹ˆë‹¤.");
                    
                    const clickedButton = document.querySelector(`button[data-number-id="${turnCount-1}"]`);
                    if (!clickedButton) {
                        showStatusMessage('âŒ ë²„íŠ¼ ì°¸ì¡° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                        return;
                    }
                    
                    const originalNumber = JSON.parse(clickedButton.getAttribute('data-original-number'));
                    const reason = placementData.reason || `ìˆ«ì ${originalNumber}ëŠ” ë©”ì¸ ì¡´ì—ì„œ ì—°ì† ì˜¤ë¦„ì°¨ìˆœì„ ë§Œë“¤ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`;
                    
                    enterManualMode({ number: originalNumber, button: clickedButton }, reason);
                    return;
                }
                
                // ì¼ë°˜ AI ë°°ì¹˜ ì²˜ë¦¬
                const clickedButton = document.querySelector(`button[data-number-id="${turnCount-1}"]`);
                
                if (!clickedButton) {
                    showStatusMessage('âŒ ë²„íŠ¼ ì°¸ì¡° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                    return;
                }
                
                const originalNumber = JSON.parse(clickedButton.getAttribute('data-original-number'));

                // AI ì‘ë‹µ ê²€ì¦
                if (!placementData || 
                    typeof placementData.index !== 'number' || 
                    typeof placementData.number === 'undefined' ||
                    placementData.index < 0 || 
                    placementData.index >= BOARD_SIZE) {
                    console.error("AI ì‘ë‹µ ì˜¤ë¥˜:", placementData);
                    enterManualMode({ number: originalNumber, button: clickedButton }, "AI ì‘ë‹µ ì˜¤ë¥˜");
                    return;
                }
                
                const placementIndex = placementData.index;
                const placedNumber = placementData.number;

                // ìœ„ì¹˜ê°€ ì´ë¯¸ ì°¨ìˆëŠ”ì§€ í™•ì¸
                if (boardState[placementIndex] !== null) {
                    console.error("AIê°€ ì´ë¯¸ ì°¨ìˆëŠ” ìœ„ì¹˜ë¥¼ ì„ íƒ:", placementIndex);
                    enterManualMode({ number: originalNumber, button: clickedButton }, "AIê°€ ì˜ëª»ëœ ìœ„ì¹˜ë¥¼ ì„ íƒí–ˆìŠµë‹ˆë‹¤.");
                    return;
                }

                boardState[placementIndex] = placedNumber;
                lastPlacedIndex = placementIndex;
                renderGameBoard();
                
                // ì¡°ì»¤ ë°°ì¹˜ ì •ë³´ í‘œì‹œ (ì—…ë°ì´íŠ¸: ì¡°ì»¤ëŠ” ê·¸ëŒ€ë¡œ ë°°ì¹˜)
                if (originalNumber === 'â˜…') {
                    showStatusMessage(`ğŸŒŸ ì¡°ì»¤ê°€ ìœ„ì¹˜ ${placementIndex + 1}ì— ë°°ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success');
                } else {
                    showStatusMessage(`âœ… ${placedNumber}ê°€ ìœ„ì¹˜ ${placementIndex + 1}ì— ë°°ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                }

                if (turnCount >= BOARD_SIZE) { 
                    elements.turnCounter.textContent = ' (ì™„ë£Œ)'; 
                    endGame(); 
                } else { 
                    updateTurnCounter(); 
                }
            }

            function onAIFailure(error) {
                elements.loadingOverlay.classList.remove('show');
                console.error("AI í˜¸ì¶œ ì‹¤íŒ¨:", error);
                
                const clickedButton = document.querySelector(`button[data-number-id="${turnCount-1}"]`);
                if(clickedButton) {
                    const originalNumber = JSON.parse(clickedButton.getAttribute('data-original-number'));
                    enterManualMode({ number: originalNumber, button: clickedButton }, `AI í˜¸ì¶œ ì‹¤íŒ¨: ${error.message}`);
                } else {
                    showStatusMessage('âŒ AI í˜¸ì¶œ ì‹¤íŒ¨: ' + error.message, 'error');
                }
            }
            
            function handleNumberClick(numberOrJoker, buttonEl) {
                if (turnCount >= BOARD_SIZE || gameInProgress || manualModeActive) return;
                
                gameInProgress = true;
                buttonEl.disabled = true;
                buttonEl.setAttribute('data-number-id', turnCount);
                buttonEl.setAttribute('data-original-number', JSON.stringify(numberOrJoker));
                
                // ë‚¨ì€ ìˆ«ìë“¤ ê³„ì‚°
                const remainingNumbers = [];
                document.querySelectorAll('.number-btn:not(:disabled)').forEach(btn => {
                    const num = btn.textContent;
                    remainingNumbers.push(num === 'â˜…' ? num : parseInt(num));
                });

                turnCount++;
                elements.loadingOverlay.classList.add('show');
                
                try {
                    google.script.run
                        .withSuccessHandler((result) => {
                            gameInProgress = false;
                            onAISuccess(result);
                        })
                        .withFailureHandler((error) => {
                            gameInProgress = false;
                            onAIFailure(error);
                        })
                        .getAIBestMove(boardState, numberOrJoker, remainingNumbers);
                } catch (error) {
                    gameInProgress = false;
                    elements.loadingOverlay.classList.remove('show');
                    showStatusMessage('âŒ ì‹œìŠ¤í…œ ì˜¤ë¥˜: ' + error.message, 'error');
                }
            }
            
            function renderGameBoard(colorMap = null) {
                elements.gameBoard.innerHTML = '';
                const domCellMap = new Map();

                BOARD_MAP.forEach((pos, index) => {
                    const cellEl = document.createElement('div');
                    cellEl.classList.add('board-cell', 'active');
                    cellEl.style.gridRowStart = pos.r;
                    cellEl.style.gridColumnStart = pos.c;
                    cellEl.dataset.boardIndex = index;
                    
                    if (boardState[index] !== null) {
                        cellEl.textContent = boardState[index];
                        cellEl.classList.add('filled');
                        
                        // ì¡°ì»¤ ìŠ¤íƒ€ì¼ ì ìš©
                        if (boardState[index] === 'â˜…') {
                            cellEl.classList.add('joker');
                        }
                    }
                    
                    if (index === lastPlacedIndex && !colorMap) {
                        cellEl.classList.add('highlight');
                    }
                    
                    if (colorMap && colorMap[index]) {
                        cellEl.style.backgroundColor = colorMap[index];
                        cellEl.style.borderColor = '#333';
                        cellEl.style.borderWidth = '3px';
                    }
                    
                    domCellMap.set(index, cellEl);
                });
                
                // ìˆœì„œëŒ€ë¡œ boardì— ì¶”ê°€
                for(let i = 0; i < BOARD_SIZE; i++) {
                    elements.gameBoard.appendChild(domCellMap.get(i));
                }
            }
            
            function createDeck() { 
                const deck = []; 
                
                // 1-10: ê° 1ì¥
                for (let i = 1; i <= 10; i++) deck.push(i); 
                
                // 11-19: ê° 2ì¥  
                for (let i = 11; i <= 19; i++) { 
                    deck.push(i); 
                    deck.push(i); 
                } 
                
                // 20-30: ê° 1ì¥
                for (let i = 20; i <= 30; i++) deck.push(i); 
                
                // ì¡°ì»¤ 1ì¥
                deck.push('â˜…'); 
                
                // ì •ë ¬
                deck.sort((a, b) => { 
                    if (a === 'â˜…') return 1; 
                    if (b === 'â˜…') return -1; 
                    return a - b; 
                }); 
                
                return deck; 
            }
            
            // *** ì¡°ì»¤ ìµœì í™”ë¥¼ ê³ ë ¤í•œ ì ìˆ˜ ê³„ì‚° (ë©”ì¸ í•¨ìˆ˜) ***
            function calculateScore(currentBoard) { 
                console.log("=== ì¡°ì»¤ ìµœì í™” ì ìˆ˜ ê³„ì‚° ì‹œì‘ ===");
                console.log("ë³´ë“œ ìƒíƒœ:", currentBoard);
                
                const result = calculateOptimalScore(currentBoard);
                
                console.log(`=== ìµœì¢… ì ìˆ˜: ${result.totalScore} ===`);
                console.log("ëŸ° êµ¬ì„±:", result.runs);
                return result.totalScore; 
            }
            
            // *** ë™ì  í”„ë¡œê·¸ë˜ë°ì„ ì´ìš©í•œ ì¡°ì»¤ ìµœì í™” ì ìˆ˜ ê³„ì‚° ***
            function calculateOptimalScore(board) {
                console.log("=== ë™ì  í”„ë¡œê·¸ë˜ë° ì ìˆ˜ ê³„ì‚° ===");
                
                // ë¹ˆ ì¹¸ë“¤ì„ ì œê±°í•˜ê³  ì—°ì†ëœ ìˆ«ìë“¤ë§Œ ì¶”ì¶œ
                const filledElements = [];
                const positionMap = [];
                
                for (let i = 0; i < BOARD_SIZE; i++) {
                    if (board[i] !== null) {
                        filledElements.push(board[i]);
                        positionMap.push(i);
                    }
                }
                
                if (filledElements.length === 0) {
                    return { totalScore: 0, runs: [] };
                }
                
                console.log("ì—°ì†ëœ ìš”ì†Œë“¤:", filledElements);
                
                // ë™ì  í”„ë¡œê·¸ë˜ë° í…Œì´ë¸” ì´ˆê¸°í™”
                // dp[i] = ië²ˆì§¸ ìš”ì†Œê¹Œì§€ ê³ ë ¤í–ˆì„ ë•Œì˜ ìµœëŒ€ ì ìˆ˜ì™€ ëŸ° êµ¬ì„±
                const dp = new Array(filledElements.length);
                const runConfig = new Array(filledElements.length);
                
                // ì²« ë²ˆì§¸ ìš”ì†Œ ì´ˆê¸°í™”
                dp[0] = SCORE_TABLE[1] || 0;
                runConfig[0] = [{ start: 0, end: 0, score: dp[0] }];
                
                console.log(`DP[0] = ${dp[0]} (ë‹¨ì¼ ìš”ì†Œ)`);
                
                // ë™ì  í”„ë¡œê·¸ë˜ë°ìœ¼ë¡œ ìµœì í•´ ê³„ì‚°
                for (let i = 1; i < filledElements.length; i++) {
                    let maxScore = 0;
                    let bestConfig = [];
                    
                    // ì˜µì…˜ 1: í˜„ì¬ ìš”ì†Œë¥¼ ë‹¨ë… ëŸ°ìœ¼ë¡œ ì²˜ë¦¬
                    const singleScore = dp[i - 1] + (SCORE_TABLE[1] || 0);
                    if (singleScore > maxScore) {
                        maxScore = singleScore;
                        bestConfig = [...runConfig[i - 1], { start: i, end: i, score: SCORE_TABLE[1] || 0 }];
                    }
                    
                    // ì˜µì…˜ 2: ì´ì „ ìš”ì†Œë“¤ê³¼ ì—°ê²°í•˜ì—¬ ëŸ° í™•ì¥
                    for (let j = i - 1; j >= 0; j--) {
                        const runElements = filledElements.slice(j, i + 1);
                        
                        if (isValidOptimalRun(runElements)) {
                            const runLength = i - j + 1;
                            const runScore = SCORE_TABLE[Math.min(runLength, SCORE_TABLE.length - 1)] || 0;
                            const totalScore = (j > 0 ? dp[j - 1] : 0) + runScore;
                            
                            if (totalScore > maxScore) {
                                maxScore = totalScore;
                                const prevRuns = j > 0 ? runConfig[j - 1] : [];
                                bestConfig = [...prevRuns, { start: j, end: i, score: runScore }];
                            }
                        } else {
                            break; // ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ ë” ê¸´ ëŸ°ë„ ìœ íš¨í•˜ì§€ ì•ŠìŒ
                        }
                    }
                    
                    dp[i] = maxScore;
                    runConfig[i] = bestConfig;
                    
                    console.log(`DP[${i}] = ${maxScore}`);
                }
                
                // ìµœì¢… ê²°ê³¼ êµ¬ì„±
                const finalRuns = runConfig[filledElements.length - 1].map(run => ({
                    elements: filledElements.slice(run.start, run.end + 1),
                    length: run.end - run.start + 1,
                    score: run.score,
                    startPos: positionMap[run.start]
                }));
                
                return {
                    totalScore: dp[filledElements.length - 1],
                    runs: finalRuns
                };
            }
            
            // *** ì¡°ì»¤ë¥¼ ê³ ë ¤í•œ ëŸ° ìœ íš¨ì„± ê²€ì‚¬ (ìµœì í™” ë²„ì „) ***
            function isValidOptimalRun(elements) {
                if (elements.length <= 1) return true;
                
                console.log(`ëŸ° ìœ íš¨ì„± ê²€ì‚¬: [${elements.join(', ')}]`);
                
                // ì¡°ì»¤ê°€ ì—†ëŠ” ê²½ìš°
                if (!elements.includes('â˜…')) {
                    for (let i = 0; i < elements.length - 1; i++) {
                        if (elements[i] > elements[i + 1]) {
                            console.log(`ì˜¤ë¦„ì°¨ìˆœ ìœ„ë°˜: ${elements[i]} > ${elements[i + 1]}`);
                            return false;
                        }
                    }
                    console.log("âœ… ìœ íš¨í•œ ì˜¤ë¦„ì°¨ìˆœ ëŸ°");
                    return true;
                }
                
                // ì¡°ì»¤ê°€ í¬í•¨ëœ ê²½ìš° - ìµœì  ë°°ì¹˜ ì‹œë„
                return canJokerMakeValidRun(elements);
            }
            
            // *** ì¡°ì»¤ê°€ ìœ íš¨í•œ ëŸ°ì„ ë§Œë“¤ ìˆ˜ ìˆëŠ”ì§€ í™•ì¸ ***
            function canJokerMakeValidRun(elements) {
                console.log(`ì¡°ì»¤ ëŸ° ê²€ì‚¬: [${elements.join(', ')}]`);
                
                // ëª¨ë“  ì¡°ì»¤ ìœ„ì¹˜ ì°¾ê¸°
                const jokerIndices = [];
                for (let i = 0; i < elements.length; i++) {
                    if (elements[i] === 'â˜…') {
                        jokerIndices.push(i);
                    }
                }
                
                // í˜„ì¬ëŠ” ì¡°ì»¤ 1ê°œë§Œ ì²˜ë¦¬ (í™•ì¥ ê°€ëŠ¥)
                if (jokerIndices.length > 1) {
                    console.log("ë³µìˆ˜ ì¡°ì»¤ëŠ” ì•„ì§ ë¯¸ì§€ì›");
                    return true; // ì¼ë‹¨ ìœ íš¨í•˜ë‹¤ê³  ê°€ì •
                }
                
                const jokerIndex = jokerIndices[0];
                
                // ì¡°ì»¤ì˜ ì•ë’¤ ì œì•½ ì¡°ê±´ ê³„ì‚°
                let minValue = -Infinity;
                let maxValue = Infinity;
                
                // ì™¼ìª½ ì œì•½
                if (jokerIndex > 0) {
                    const leftValue = elements[jokerIndex - 1];
                    if (leftValue !== 'â˜…') {
                        minValue = Math.max(minValue, leftValue);
                    }
                }
                
                // ì˜¤ë¥¸ìª½ ì œì•½
                if (jokerIndex < elements.length - 1) {
                    const rightValue = elements[jokerIndex + 1];
                    if (rightValue !== 'â˜…') {
                        maxValue = Math.min(maxValue, rightValue);
                    }
                }
                
                console.log(`ì¡°ì»¤ ì œì•½: ${minValue} â‰¤ â˜… â‰¤ ${maxValue}`);
                
                // ì¡°ì»¤ê°€ ë²”ìœ„ë¥¼ ë§Œì¡±í•  ìˆ˜ ìˆëŠ”ì§€ í™•ì¸
                if (minValue > maxValue) {
                    console.log("âŒ ì¡°ì»¤ ì œì•½ ìœ„ë°˜: ë¶ˆê°€ëŠ¥í•œ ë²”ìœ„");
                    return false;
                }
                
                // ì¡°ì»¤ë¥¼ ì ì ˆí•œ ê°’ìœ¼ë¡œ ì¹˜í™˜í•˜ì—¬ ì „ì²´ ëŸ°ì´ ì˜¤ë¦„ì°¨ìˆœì¸ì§€ í™•ì¸
                const testElements = [...elements];
                let jokerValue = minValue;
                
                if (maxValue !== Infinity && minValue !== -Infinity) {
                    jokerValue = Math.floor((minValue + maxValue) / 2);
                } else if (maxValue !== Infinity) {
                    jokerValue = maxValue - 1;
                } else if (minValue !== -Infinity) {
                    jokerValue = minValue + 1;
                } else {
                    jokerValue = 15; // ê¸°ë³¸ê°’
                }
                
                testElements[jokerIndex] = jokerValue;
                
                // ì „ì²´ ëŸ°ì´ ì˜¤ë¦„ì°¨ìˆœì¸ì§€ í™•ì¸
                for (let i = 0; i < testElements.length - 1; i++) {
                    if (testElements[i] > testElements[i + 1]) {
                        console.log(`âŒ ì¹˜í™˜ í›„ ì˜¤ë¦„ì°¨ìˆœ ìœ„ë°˜: ${testElements[i]} > ${testElements[i + 1]}`);
                        return false;
                    }
                }
                
                console.log(`âœ… ì¡°ì»¤ ëŸ° ìœ íš¨ (ì¡°ì»¤=${jokerValue})`);
                return true;
            }
            
            function renderScoreTable() { 
                elements.scoreCol1.innerHTML = ''; 
                elements.scoreCol2.innerHTML = ''; 
                
                for(let i = 1; i <= 10; i++) { 
                    const entry = document.createElement('div'); 
                    entry.classList.add('score-entry'); 
                    entry.innerHTML = `<span>${i}ì¹¸</span> <span>+${SCORE_TABLE[i]}</span>`; 
                    elements.scoreCol1.appendChild(entry); 
                } 
                
                for(let i = 11; i <= 20; i++) { 
                    const entry = document.createElement('div'); 
                    entry.classList.add('score-entry'); 
                    entry.innerHTML = `<span>${i}ì¹¸</span> <span>+${SCORE_TABLE[i]}</span>`; 
                    elements.scoreCol2.appendChild(entry); 
                } 
            }
            
            function renderNumberPanel() { 
                elements.numberPanel.innerHTML = ''; 
                
                fullDeck.forEach(num => { 
                    const btn = document.createElement('button'); 
                    btn.classList.add('number-btn'); 
                    btn.textContent = num; 
                    
                    if(num === 'â˜…') {
                        btn.classList.add('joker');
                        btn.title = 'ì¡°ì»¤: ì–´ë–¤ ìˆ«ìì™€ë„ ì—°ê²°ë©ë‹ˆë‹¤';
                    }
                    
                    btn.addEventListener('click', () => handleNumberClick(num, btn)); 
                    elements.numberPanel.appendChild(btn); 
                }); 
            }
            
            function updateTurnCounter() { 
                elements.turnCounter.textContent = ` (${Math.min(turnCount, BOARD_SIZE)}/20)`; 
            }
            
            function endGame() { 
                console.log("=== ê²Œì„ ì¢…ë£Œ - ì ìˆ˜ ê³„ì‚° ë° ìƒ‰ì¹  ===");
                
                // ìƒˆë¡œìš´ ì ìˆ˜ ê³„ì‚° ë¡œì§ìœ¼ë¡œ ëŸ°ë“¤ê³¼ ì´ì  ê³„ì‚°
                const scoreResult = calculateScoreWithRuns(boardState);
                const totalScore = scoreResult.totalScore;
                const runs = scoreResult.runs;
                
                // ìƒ‰ì¹  ë§µ ìƒì„±
                const colorMap = Array(BOARD_SIZE).fill(null);
                let colorIndex = 0;
                
                runs.forEach((run, index) => {
                    console.log(`ëŸ° ${index + 1}: [${run.elements.join(', ')}] (ê¸¸ì´: ${run.length}, ì ìˆ˜: ${run.score})`);
                    
                    // ëŸ°ì´ 2ì¹¸ ì´ìƒì´ë©´ ìƒ‰ì¹ 
                    if (run.length >= 2) {
                        const runColor = RUN_COLORS[colorIndex % RUN_COLORS.length];
                        for (let j = run.startPos; j < run.startPos + run.elements.length; j++) {
                            if (j < BOARD_SIZE && boardState[j] !== null) {
                                colorMap[j] = runColor;
                            }
                        }
                        colorIndex++;
                    }
                });
                
                console.log(`ìµœì¢… ì´ì : ${totalScore}`);
                
                renderGameBoard(colorMap); 
                elements.finalScoreValue.textContent = totalScore; 
                elements.finalScoreOverlay.classList.add('show'); 
                
                showStatusMessage(`ğŸ‰ ê²Œì„ ì™„ë£Œ! ìµœì¢… ì ìˆ˜: ${totalScore}ì `, 'success');
            }
            
            // ì ìˆ˜ ê³„ì‚°ê³¼ ëŸ° ì •ë³´ë¥¼ í•¨ê»˜ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜ (ê²Œì„ ì¢…ë£Œìš©)
            function calculateScoreWithRuns(board) {
                console.log("=== ì ìˆ˜ ê³„ì‚° with ëŸ° ì •ë³´ ===");
                
                const result = calculateOptimalScore(board);
                return result;
            }
            
            function initGame() { 
                boardState = Array(BOARD_SIZE).fill(null); 
                turnCount = 0; 
                lastPlacedIndex = -1; 
                gameInProgress = false;
                manualModeActive = false;
                currentManualNumber = null;
                fullDeck = createDeck(); 
                
                elements.finalScoreOverlay.classList.remove('show'); 
                elements.loadingOverlay.classList.remove('show');
                elements.statusMessage.innerHTML = '';
                hideManualInstruction();
                
                renderScoreTable(); 
                renderNumberPanel(); 
                renderGameBoard(); 
                updateTurnCounter(); 
                
                showStatusMessage('ğŸš€ ìƒˆ ê²Œì„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤! ìˆ«ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'success');
            }
            
            elements.resetButton.addEventListener('click', () => {
                if (confirm('ì •ë§ë¡œ ê²Œì„ì„ ë‹¤ì‹œ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    initGame();
                }
            });
            
            // ê²Œì„ ì´ˆê¸°í™”
            initGame();
        });
    </script>
</body>
</html>